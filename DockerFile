# ==========================================
# Stage 1: Build Frontend (Client)
# ==========================================
FROM node:18-alpine AS client-builder

WORKDIR /app/client

# Copy frontend dependencies
COPY client/package*.json ./
RUN npm ci

# Copy frontend source
COPY client/ ./

# Build the React/Vite app
# (The output will be in /app/client/dist)
RUN npm run build

# ==========================================
# Stage 2: Build Backend (Server)
# ==========================================
FROM node:18-alpine AS server-builder

WORKDIR /app/server

# Copy backend dependencies
COPY server/package*.json ./
RUN npm ci --only=production

# ==========================================
# Stage 3: Final Production Image
# ==========================================
FROM node:18-alpine AS runner

WORKDIR /app

# Set environment to production
ENV NODE_ENV=production
ENV PORT=3001

# Copy Backend Dependencies & Source
COPY --from=server-builder /app/server/node_modules ./server/node_modules
COPY server/ ./server/

# Copy Frontend Build to Backend's Public Directory
# (Express will serve these static files)
COPY --from=client-builder /app/client/dist ./server/public

# Expose the application port
EXPOSE 3001

# Start the application
CMD ["node", "server/server.js"]